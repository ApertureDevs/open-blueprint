name: Continuous Integration checks

on: push

jobs:
  frontend-ci:
    name: Frontend CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Add Task runner
        run: |
          curl -sL https://taskfile.dev/install.sh | sh && echo "::add-path::./bin"
      - name: NPM audit
        run: |
          task frontend-npm-audit-check --summary
          task frontend-npm-audit-check
      - name: Typescript linter
        run: |
          task frontend-ts-linter-dry-run --summary
          task frontend-ts-linter-dry-run
      - name: SASS linter
        run: |
          task frontend-sass-linter-dry-run --summary
          task frontend-sass-linter-dry-run
      - name: HTML linter
        run: |
          task frontend-html-linter-dry-run --summary
          task frontend-html-linter-dry-run
      - name: Karma Test
        run: |
          task frontend-karma --summary
          task frontend-karma
      - name: Protractor Test
        run: |
          task frontend-protractor --summary
          task frontend-protractor
      - name: Build Prod
        run: |
          task frontend-build --summary
          BUILD_ENV=prod task frontend-build
      - name: Build Dev
        run: |
          task frontend-build --summary
          BUILD_ENV=dev task frontend-build

  api-ci:
    name: API CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Add Task runner
        run: |
          curl -sL https://taskfile.dev/install.sh | sh && echo "::add-path::./bin"
      - name: Test Database
        run: |
          task api-database-test --summary
          task api-database-test
      - name: PHP linter
        run: |
          task api-php-linter-dry-run --summary
          task api-php-linter-dry-run
      - name: PHP static analysis
        run: |
          task api-php-static-analysis --summary
          task api-php-static-analysis
      - name: PHP dependencies check
        run: |
          task api-composer-check --summary
          task api-composer-check
      - name: Build Prod
        run: |
          task frontend-build --summary
          BUILD_ENV=prod task api-build
      - name: Build Dev
        run: |
          task frontend-build --summary
          BUILD_ENV=dev task api-build
